---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/001_initial_schema.sql
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - middleware.ts
  - .env.local.example
  - src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Supabase project is connected and queries succeed"
    - "RLS prevents anonymous users from writing to any table"
    - "Anonymous users can read published reports and categories"
    - "Categories table contains 7 entries (one per day of week)"
    - "Topic history table exists for future repetition prevention"
  artifacts:
    - path: "supabase/migrations/001_initial_schema.sql"
      provides: "Database schema with reports, categories, topic_history tables"
      contains: "CREATE TABLE reports"
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
    - path: "middleware.ts"
      provides: "Auth session refresh middleware"
      contains: "supabase.auth.getUser"
    - path: "src/types/database.ts"
      provides: "TypeScript types for database tables"
      exports: ["Report", "Category", "TopicHistory"]
  key_links:
    - from: "src/lib/supabase/server.ts"
      to: "cookies from next/headers"
      via: "createServerClient cookie handling"
      pattern: "cookies\\(\\)"
    - from: "middleware.ts"
      to: "src/lib/supabase patterns"
      via: "createServerClient with request cookies"
      pattern: "createServerClient"
---

<objective>
Create the database foundation for The Daily Deep: Supabase schema with reports, categories, and topic history tables, plus Row Level Security policies ensuring public read access while preventing unauthorized writes.

Purpose: Every other plan depends on having a working database with proper security. This is the foundation that pages query against.

Output: Working Supabase connection with typed queries, RLS policies active, and 7 categories seeded for daily rotation.

Note: The category rotation schedule (TOPIC-01) stores day_of_week mappings in the database. The logic to SELECT the appropriate category for "today" will be implemented in Phase 2 (Generation Engine) when the admin dashboard and generation trigger are built, as that's when the category selection is actually needed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md

Reference RESEARCH.md for:
- Supabase client patterns (Pattern 1, Pattern 2)
- Database schema example
- RLS policy examples
- Common pitfalls (especially Pitfall 1: RLS Without Policies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js project with Supabase dependencies</name>
  <files>
    package.json
    .env.local.example
    tsconfig.json
  </files>
  <action>
Create a new Next.js 14 project with TypeScript and App Router:

```bash
npx create-next-app@14 . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --use-npm
```

Install Supabase dependencies:
```bash
npm install @supabase/supabase-js @supabase/ssr
```

Create `.env.local.example` with required environment variables:
```
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

User will need to:
1. Create Supabase project at supabase.com
2. Copy URL and anon key from project settings
3. Create `.env.local` from example
  </action>
  <verify>
    - `npm run build` succeeds (Next.js builds)
    - `package.json` includes @supabase/supabase-js and @supabase/ssr
    - `.env.local.example` exists and contains NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY placeholders
  </verify>
  <done>Next.js 14 project initialized with Supabase packages installed</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client utilities and middleware</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    middleware.ts
  </files>
  <action>
Create browser client (`src/lib/supabase/client.ts`):
- Use `createBrowserClient` from @supabase/ssr
- Export a `createClient` function
- Read from NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY

Create server client (`src/lib/supabase/server.ts`):
- Use `createServerClient` from @supabase/ssr
- Export an async `createClient` function
- Use `cookies()` from next/headers
- Handle cookie getAll/setAll with try/catch for Server Components (see RESEARCH.md Pattern 1)

Create middleware (`middleware.ts` at project root):
- Refresh auth session on every request
- Use pattern from RESEARCH.md Pattern 2
- Matcher excludes static files: `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)`
  </action>
  <verify>
    - `npm run build` succeeds
    - All three files exist with correct exports
    - No TypeScript errors
  </verify>
  <done>Supabase client utilities ready for browser, server, and middleware contexts</done>
</task>

<task type="auto">
  <name>Task 3: Create database schema migration and TypeScript types</name>
  <files>
    supabase/migrations/001_initial_schema.sql
    src/types/database.ts
  </files>
  <action>
Create SQL migration file (`supabase/migrations/001_initial_schema.sql`) with:

**Categories table:**
- id (UUID, primary key, gen_random_uuid)
- name (TEXT, not null, unique)
- slug (TEXT, not null, unique) - for URL-friendly category names
- day_of_week (INT, 0-6, not null) - 0=Sunday, 6=Saturday
- created_at (TIMESTAMPTZ, default now)

**Reports table:**
- id (UUID, primary key, gen_random_uuid)
- slug (TEXT, not null, unique)
- title (TEXT, not null)
- subtitle (TEXT, nullable)
- content (TEXT, not null) - markdown content
- summary (TEXT, nullable) - brief excerpt
- category_id (UUID, references categories)
- status (TEXT, default 'draft', check IN ('draft', 'published', 'generating'))
- published_at (TIMESTAMPTZ, nullable)
- word_count (INT, nullable)
- reading_time (INT, nullable) - in minutes
- sources (JSONB, nullable) - array of {name, url}
- regions (TEXT[], nullable) - regions covered
- seo_title (TEXT, nullable)
- seo_description (TEXT, nullable)
- seo_keywords (TEXT[], nullable)
- created_at (TIMESTAMPTZ, default now)
- updated_at (TIMESTAMPTZ, default now)

**Topic history table:**
- id (UUID, primary key, gen_random_uuid)
- topic (TEXT, not null)
- category_id (UUID, references categories)
- report_id (UUID, references reports, nullable)
- used_at (TIMESTAMPTZ, default now)

**RLS Policies:**
1. Enable RLS on all three tables
2. `reports` - anon can SELECT where status = 'published'
3. `categories` - anon can SELECT all (public reference data)
4. `topic_history` - NO anon access (internal use only)

**Seed data:**
Insert 7 categories with day_of_week assignments:
- Sunday (0): Geopolitics
- Monday (1): Economics
- Tuesday (2): Technology
- Wednesday (3): Climate
- Thursday (4): Society
- Friday (5): Science
- Saturday (6): Conflict

**Indexes:**
- reports(status)
- reports(published_at DESC)
- reports(category_id)
- reports(slug)
- topic_history(category_id)
- topic_history(used_at DESC)

Create TypeScript types (`src/types/database.ts`):
- Export interfaces: Report, Category, TopicHistory
- Export type for sources JSONB: Source = { name: string; url: string }
- Match SQL schema exactly
  </action>
  <verify>
    - Migration file exists at supabase/migrations/001_initial_schema.sql
    - SQL syntax is valid (no obvious errors)
    - TypeScript types compile without errors
    - Types match schema fields
  </verify>
  <done>Database schema ready for deployment with types for type-safe queries</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Project builds:** `npm run build` succeeds with no errors
2. **Files exist:**
   - src/lib/supabase/client.ts
   - src/lib/supabase/server.ts
   - middleware.ts
   - supabase/migrations/001_initial_schema.sql
   - src/types/database.ts
3. **Types are correct:** No TypeScript errors in database.ts
4. **Migration is valid SQL:** File contains CREATE TABLE, ENABLE ROW LEVEL SECURITY, CREATE POLICY statements

Note: Actual database deployment and RLS testing requires user to configure Supabase project. Migration file is ready to run via Supabase dashboard or CLI.
</verification>

<success_criteria>
- Next.js 14 project initialized with App Router and TypeScript
- Supabase client utilities work for browser, server, and middleware contexts
- Database migration file contains complete schema with RLS policies
- TypeScript types provide type safety for all database operations
- 7 categories seeded for daily rotation schedule
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
