---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/app/report/[slug]/page.tsx
  - src/components/report/report-content.tsx
  - src/components/report/report-header.tsx
  - src/components/report/report-toc.tsx
  - src/components/report/report-sources.tsx
  - src/lib/utils/reading-time.ts
  - src/lib/utils/format-date.ts
  - src/lib/utils/extract-headings.ts
autonomous: true

must_haves:
  truths:
    - "User can view a report at /report/[slug] URL"
    - "Markdown content renders with proper typography (headings, paragraphs, tables)"
    - "Tables display with minimal borders in editorial style"
    - "Blockquotes have gold left border accent"
    - "Links are gold and open external URLs in new tab"
    - "Sticky table of contents shows on desktop, highlights current section"
    - "Reading time displays in report header"
    - "Sources section lists citations with clickable links"
  artifacts:
    - path: "src/app/report/[slug]/page.tsx"
      provides: "Report detail page with SSR data fetching"
      contains: "generateMetadata"
    - path: "src/components/report/report-content.tsx"
      provides: "Markdown renderer with custom styled components"
      contains: "ReactMarkdown"
    - path: "src/components/report/report-toc.tsx"
      provides: "Sticky sidebar table of contents"
      contains: "IntersectionObserver"
    - path: "src/lib/utils/reading-time.ts"
      provides: "Reading time calculation utility"
      exports: ["calculateReadingTime"]
  key_links:
    - from: "src/app/report/[slug]/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "createClient for SSR fetch"
      pattern: "createClient\\(\\)"
    - from: "src/components/report/report-content.tsx"
      to: "react-markdown"
      via: "ReactMarkdown with remarkGfm"
      pattern: "remarkPlugins.*remarkGfm"
---

<objective>
Build the report detail page that renders markdown content with premium editorial styling: custom typography, styled tables, blockquotes with gold accents, sticky table of contents, and sources section.

Purpose: This is the core reading experience. Reports are 3,500+ words and need excellent typography and navigation (TOC) to be readable.

Output: /report/[slug] page that beautifully renders any published report with proper SSR for SEO.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

Reference CONTEXT.md for:
- Tables with minimal lines
- Citations as inline links
- Sticky sidebar TOC on desktop
- Blockquotes with left border accent

Reference RESEARCH.md for:
- Pattern 4: Custom Markdown Components
- Sticky Table of Contents with Intersection Observer
- Reading time calculation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install markdown dependencies and create utility functions</name>
  <files>
    package.json
    src/lib/utils/reading-time.ts
    src/lib/utils/format-date.ts
    src/lib/utils/extract-headings.ts
  </files>
  <action>
Install markdown rendering packages:
```bash
npm install react-markdown remark-gfm reading-time
```

Create reading time utility (`src/lib/utils/reading-time.ts`):
- Use the `reading-time` package
- Export `calculateReadingTime(content: string): number` returning minutes
- Round up to nearest minute with Math.ceil

Create date formatting utility (`src/lib/utils/format-date.ts`):
- Export `formatDate(date: string | Date): string`
- Format as "January 25, 2026" style using Intl.DateTimeFormat
- Handle both ISO strings and Date objects

Create heading extraction utility (`src/lib/utils/extract-headings.ts`):
- Export `extractHeadings(markdown: string): Heading[]`
- Heading type: `{ id: string; text: string; level: number }`
- Parse markdown for h2 and h3 headings (## and ###)
- Generate slugified IDs from heading text (lowercase, spaces to hyphens, remove special chars)
- These headings will be used for the table of contents
  </action>
  <verify>
    - All three utility files exist and export their functions
    - `npm run build` succeeds
    - No TypeScript errors
  </verify>
  <done>Utility functions ready for reading time, date formatting, and heading extraction</done>
</task>

<task type="auto">
  <name>Task 2: Create markdown renderer and report components</name>
  <files>
    src/components/report/report-content.tsx
    src/components/report/report-header.tsx
    src/components/report/report-toc.tsx
    src/components/report/report-sources.tsx
  </files>
  <action>
Create report content renderer (`src/components/report/report-content.tsx`):
- Client component ("use client") for interactive elements
- Use ReactMarkdown with remarkGfm plugin
- Custom components object with styled elements:

**Headings (h1, h2, h3):**
- font-playfair, appropriate sizes (text-4xl, text-2xl, text-xl)
- h2 and h3 get id attributes from slugified text (for TOC links)
- Proper margins (mt-10 mb-4 for h2, mt-8 mb-3 for h3)

**Paragraphs:**
- font-serif for body text feel
- text-lg, leading-relaxed (line-height)
- text-foreground/90 for slightly muted body

**Tables:**
- Wrapper div with overflow-x-auto for mobile
- Minimal borders: only bottom border on rows (border-b border-border/30)
- Header cells: border-b border-border/50, font-semibold
- Clean, uncluttered data-forward appearance

**Blockquotes:**
- border-l-4 border-primary (gold left border)
- pl-4 for padding, italic text
- text-foreground/70 for muted quote text

**Links:**
- text-primary (gold) with hover:text-primary/80
- underline underline-offset-2
- External links (http) get target="_blank" rel="noopener noreferrer"

**Lists (ul, ol, li):**
- Proper spacing and indentation
- Custom bullet styling if needed

**Code blocks:**
- bg-muted rounded-md p-4
- overflow-x-auto for long lines

Create report header (`src/components/report/report-header.tsx`):
- Props: title, subtitle?, category, publishedAt, readingTime
- Large title in font-playfair
- Subtitle if present
- Meta line: category badge, date, reading time
- Category badge with bg-primary/20 text-primary styling

Create table of contents (`src/components/report/report-toc.tsx`):
- Client component for IntersectionObserver
- Props: headings array from extractHeadings
- Sticky positioning: `sticky top-24 hidden lg:block`
- Highlight active section based on scroll position
- Links scroll to heading IDs
- Use IntersectionObserver to track which heading is in view
- Indentation based on heading level (h3 indented under h2)

Create sources section (`src/components/report/report-sources.tsx`):
- Props: sources array of {name: string, url: string}
- Section heading "Sources"
- Numbered list of source links
- Links styled with gold color, open in new tab
  </action>
  <verify>
    - All four component files exist
    - report-content.tsx imports ReactMarkdown and remarkGfm
    - report-toc.tsx uses IntersectionObserver
    - No TypeScript errors
  </verify>
  <done>Report components ready with editorial styling and interactive TOC</done>
</task>

<task type="auto">
  <name>Task 3: Create report detail page with SSR data fetching</name>
  <files>
    src/app/report/[slug]/page.tsx
  </files>
  <action>
Create the report detail page (`src/app/report/[slug]/page.tsx`):

**Data fetching:**
- Server component (no "use client")
- Import createClient from src/lib/supabase/server
- Fetch report by slug where status = 'published'
- Join with categories table to get category name
- Return notFound() if report doesn't exist or isn't published

**generateMetadata function:**
- Export async generateMetadata for dynamic title/description
- Title: report.seo_title or report.title
- Description: report.seo_description or report.summary or truncated content

**Page layout:**
Two-column layout on desktop:
- Main content (left): ~70% width, contains header and markdown content
- Sidebar (right): ~30% width, contains sticky TOC
- On mobile: single column, TOC hidden

Structure:
```tsx
<article className="max-w-6xl mx-auto px-4 py-8">
  <div className="lg:grid lg:grid-cols-[1fr_280px] lg:gap-12">
    <main>
      <ReportHeader ... />
      <ReportContent content={report.content} />
      {report.sources && <ReportSources sources={report.sources} />}
    </main>
    <aside className="hidden lg:block">
      <ReportTOC headings={headings} />
    </aside>
  </div>
</article>
```

**Heading extraction:**
- Call extractHeadings(report.content) to get headings for TOC
- Pass to ReportTOC component

**Reading time:**
- Use report.reading_time if stored, otherwise calculate from content

**Error handling:**
- 404 if slug not found
- Handle missing optional fields gracefully (subtitle, sources, etc.)
  </action>
  <verify>
    - File exists at src/app/report/[slug]/page.tsx
    - Imports createClient from server utilities
    - Has generateMetadata export
    - Uses notFound for missing reports
    - `npm run build` succeeds
  </verify>
  <done>Report detail page complete with SSR, metadata, and two-column layout</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build succeeds:** `npm run build` completes without errors
2. **Page route exists:** /report/[slug] route is recognized by Next.js
3. **Components render:** All report components have no TypeScript errors

**Manual testing (requires sample data):**
To fully test, you'll need a published report in the database. Create a test by:
1. Running the migration in Supabase
2. Inserting a sample report with markdown content, tables, quotes
3. Visiting /report/[sample-slug]

Expected behavior:
- Dark background, gold accents
- Playfair Display headings
- Tables with minimal borders
- Blockquotes with gold left border
- Sticky TOC on desktop that highlights as you scroll
- Sources listed at bottom
- Proper 404 for non-existent slugs
</verification>

<success_criteria>
- /report/[slug] route renders published reports
- Markdown content displays with proper editorial typography
- Tables render with minimal, clean borders
- Blockquotes have gold left border accent
- Links are gold colored and external links open in new tabs
- Sticky table of contents visible on desktop, hidden on mobile
- TOC highlights current section while scrolling
- Reading time and metadata display in header
- Sources section renders with clickable links
- SSR metadata for SEO (title, description)
- 404 returned for non-existent or unpublished reports
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
