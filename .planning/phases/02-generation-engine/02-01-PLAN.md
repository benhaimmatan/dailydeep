---
phase: 02-generation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/admin/auth.ts
  - src/app/admin/login/page.tsx
  - src/app/admin/layout.tsx
  - src/app/api/auth/callback/route.ts
  - .env.local.example
autonomous: true

user_setup:
  - service: supabase-auth
    why: "Admin authentication requires a Supabase user account"
    env_vars:
      - name: ADMIN_EMAIL
        source: "The email address you want to use for admin login"
    dashboard_config:
      - task: "Create admin user in Supabase"
        location: "Supabase Dashboard -> Authentication -> Users -> Add User"
        details: "Create a user with email matching ADMIN_EMAIL env var"

must_haves:
  truths:
    - "Admin can visit /admin/login and see a login form"
    - "Valid credentials redirect to /admin dashboard"
    - "Invalid credentials show 'Invalid credentials' error"
    - "Non-admin users are redirected to /admin/login"
    - "Unauthenticated users cannot access /admin routes"
  artifacts:
    - path: "src/lib/admin/auth.ts"
      provides: "requireAdmin() helper function"
      exports: ["requireAdmin"]
    - path: "src/app/admin/login/page.tsx"
      provides: "Login form with email/password"
      min_lines: 40
    - path: "src/app/admin/layout.tsx"
      provides: "Protected admin layout wrapper"
      min_lines: 15
    - path: "src/app/api/auth/callback/route.ts"
      provides: "Auth callback handler"
      exports: ["GET"]
  key_links:
    - from: "src/app/admin/layout.tsx"
      to: "src/lib/admin/auth.ts"
      via: "requireAdmin() call"
      pattern: "requireAdmin\\(\\)"
    - from: "src/app/admin/login/page.tsx"
      to: "supabase.auth.signInWithPassword"
      via: "form submission"
      pattern: "signInWithPassword"
---

<objective>
Create admin authentication foundation with email/password login, protected routes, and admin role verification.

Purpose: All admin features (dashboard, report management, generation trigger) require authentication. This establishes the security boundary.

Output: Login page, protected layout, auth callback, and requireAdmin utility ready for all admin routes.
</objective>

<execution_context>
@/Users/matanbenhaim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matanbenhaim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-generation-engine/02-CONTEXT.md
@.planning/phases/02-generation-engine/02-RESEARCH.md

@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
@middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin auth utilities and callback route</name>
  <files>
    src/lib/admin/auth.ts
    src/app/api/auth/callback/route.ts
    .env.local.example
  </files>
  <action>
Create the admin authentication utilities:

1. `src/lib/admin/auth.ts`:
   - Export `requireAdmin()` async function
   - Use `createClient()` from `@/lib/supabase/server`
   - Call `supabase.auth.getUser()` (NOT getSession - security requirement)
   - If error or no user, `redirect('/admin/login')`
   - If `user.email !== process.env.ADMIN_EMAIL`, `redirect('/admin/login')`
   - Return the user object if valid admin

2. `src/app/api/auth/callback/route.ts`:
   - Export GET handler for auth callback
   - Extract `code` from searchParams
   - If code exists, call `supabase.auth.exchangeCodeForSession(code)`
   - Redirect to `/admin` on success, `/admin/login?error=auth` on failure
   - Handle missing code by redirecting to `/admin/login`

3. Update `.env.local.example`:
   - Add `ADMIN_EMAIL=your-admin@example.com` with comment

IMPORTANT: Use `getUser()` for server-side auth validation, never `getSession()`.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    - requireAdmin() function exists and uses getUser()
    - Auth callback route handles code exchange
    - ADMIN_EMAIL documented in .env.local.example
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin login page</name>
  <files>
    src/app/admin/login/page.tsx
  </files>
  <action>
Create the admin login page at `src/app/admin/login/page.tsx`:

1. Mark as 'use client' for form interactivity
2. Import `createClient` from `@/lib/supabase/client` (browser client)
3. Import `useRouter` from `next/navigation`
4. Create form state with useState: `error`, `loading`
5. Create handleSubmit function:
   - Prevent default, set loading=true
   - Call `supabase.auth.signInWithPassword({ email, password })`
   - If error, set error='Invalid credentials' (generic message per CONTEXT.md)
   - If success, `router.push('/admin')` then `router.refresh()`
6. Render form with:
   - Email input (type="email", required)
   - Password input (type="password", required)
   - Submit button with loading state
   - Error message display (if error state set)
7. Style with Tailwind:
   - Center form on page
   - Dark theme compatible (use CSS variables)
   - Card-like container with gold accent on focus states
   - Match the editorial aesthetic from Phase 1

Keep it simple - no magic link, no forgot password, no rate limiting per CONTEXT.md.
  </action>
  <verify>
    Run dev server and visit http://localhost:3000/admin/login - form renders
  </verify>
  <done>
    - Login form displays with email and password fields
    - Form styled consistently with dark theme
    - Loading state shown during submission
  </done>
</task>

<task type="auto">
  <name>Task 3: Create protected admin layout</name>
  <files>
    src/app/admin/layout.tsx
    src/app/admin/page.tsx
  </files>
  <action>
Create the protected admin layout:

1. `src/app/admin/layout.tsx`:
   - Server component (no 'use client')
   - Import `requireAdmin` from `@/lib/admin/auth`
   - Call `await requireAdmin()` at top of component
   - Return children wrapped in minimal admin shell:
     - Container with max-width
     - Optional: simple nav header with "Admin Dashboard" title and logout button
   - This layout wraps ALL /admin/* routes except /admin/login

2. `src/app/admin/page.tsx`:
   - Simple placeholder dashboard page
   - Display "Welcome to Admin Dashboard"
   - Show today's category prominently ("Today is {Category} {Day}" format)
   - Calculate today's category using day_of_week from categories table
   - Query categories from Supabase using server client
   - This will be enhanced in Plan 02-03

IMPORTANT: The layout.tsx must NOT protect /admin/login - Next.js route groups or conditional logic needed.
Solution: Check if pathname includes '/login' and skip requireAdmin, OR use a route group (admin)/(protected) for protected routes.

Simpler approach: Since login is at /admin/login, the layout at /admin/layout.tsx WILL wrap it.
Fix: Move the auth check to a nested layout or use conditional logic based on pathname.

Recommended: Create route group structure:
- src/app/admin/login/page.tsx (public)
- src/app/admin/(dashboard)/layout.tsx (protected layout with requireAdmin)
- src/app/admin/(dashboard)/page.tsx (dashboard)

This way /admin/login is NOT protected, but /admin is.
  </action>
  <verify>
    1. `npm run dev`
    2. Visit http://localhost:3000/admin - should redirect to /admin/login (not authenticated)
    3. Login page should be accessible without redirect loops
  </verify>
  <done>
    - Protected layout redirects unauthenticated users to login
    - Login page remains accessible (no infinite redirect)
    - Placeholder dashboard shows for authenticated admin
    - Today's category displayed on dashboard
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - no TypeScript errors
2. `npm run build` - builds successfully
3. Visit /admin/login - form displays
4. Submit invalid credentials - shows "Invalid credentials"
5. Visit /admin (unauthenticated) - redirects to /admin/login
6. After login with valid ADMIN_EMAIL user - dashboard displays
</verification>

<success_criteria>
- Admin authentication flow works end-to-end
- Protected routes redirect non-admins
- Login form provides appropriate feedback
- No security vulnerabilities (getUser used, not getSession)
</success_criteria>

<output>
After completion, create `.planning/phases/02-generation-engine/02-01-SUMMARY.md`
</output>
