---
phase: 02-generation-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/002_generation_jobs.sql
  - src/types/database.ts
  - src/lib/gemini/client.ts
  - src/lib/gemini/schemas.ts
  - src/lib/gemini/prompts.ts
  - .env.local.example
autonomous: true

user_setup:
  - service: google-gemini
    why: "AI report generation requires Gemini API access"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API Key -> Create API Key"
        url: "https://aistudio.google.com/apikey"

must_haves:
  truths:
    - "generation_jobs table exists in Supabase with status tracking"
    - "Gemini client can be initialized with API key"
    - "Generated reports validated for 3000+ words and 5+ sources"
    - "Prompt produces structured JSON output matching schema"
  artifacts:
    - path: "supabase/migrations/002_generation_jobs.sql"
      provides: "generation_jobs table with status, progress, error columns"
      contains: "CREATE TABLE"
    - path: "src/types/database.ts"
      provides: "GenerationJob type"
      contains: "GenerationJob"
    - path: "src/lib/gemini/client.ts"
      provides: "Gemini SDK initialization"
      exports: ["createGeminiClient", "generateReport"]
    - path: "src/lib/gemini/schemas.ts"
      provides: "Zod schemas for report structure"
      exports: ["ReportSchema", "reportJsonSchema"]
    - path: "src/lib/gemini/prompts.ts"
      provides: "Report generation prompts"
      exports: ["buildReportPrompt"]
  key_links:
    - from: "src/lib/gemini/client.ts"
      to: "@google/genai"
      via: "GoogleGenAI import"
      pattern: "GoogleGenAI"
    - from: "src/lib/gemini/client.ts"
      to: "src/lib/gemini/schemas.ts"
      via: "reportJsonSchema import"
      pattern: "reportJsonSchema"
---

<objective>
Create the generation infrastructure: database schema for job tracking, Gemini SDK client, and structured output schemas.

Purpose: Report generation takes 5-15 minutes and needs async job tracking. This creates the foundation for the generation API (Plan 02-04).

Output: generation_jobs table, typed Gemini client, Zod schemas for report validation.
</objective>

<execution_context>
@/Users/matanbenhaim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matanbenhaim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-generation-engine/02-CONTEXT.md
@.planning/phases/02-generation-engine/02-RESEARCH.md

@src/types/database.ts
@supabase/migrations/001_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create generation_jobs schema</name>
  <files>
    package.json
    supabase/migrations/002_generation_jobs.sql
    src/types/database.ts
    .env.local.example
  </files>
  <action>
1. Install required packages:
   ```bash
   npm install @google/genai zod zod-to-json-schema swr
   ```

2. Create `supabase/migrations/002_generation_jobs.sql`:
   ```sql
   -- Generation Jobs table for async report generation tracking
   CREATE TABLE generation_jobs (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     topic TEXT NOT NULL,
     category_id UUID REFERENCES categories(id),
     status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'generating', 'validating', 'completed', 'failed')),
     progress TEXT,
     error TEXT,
     report_id UUID REFERENCES reports(id),
     started_at TIMESTAMPTZ DEFAULT NOW(),
     completed_at TIMESTAMPTZ,
     created_at TIMESTAMPTZ DEFAULT NOW()
   );

   -- Index for status queries
   CREATE INDEX idx_generation_jobs_status ON generation_jobs(status);
   CREATE INDEX idx_generation_jobs_created ON generation_jobs(created_at DESC);

   -- RLS: Only authenticated users can read/write (admin check in app layer)
   ALTER TABLE generation_jobs ENABLE ROW LEVEL SECURITY;

   -- Policy: Allow authenticated users to manage generation jobs
   CREATE POLICY "Authenticated users can manage generation jobs"
     ON generation_jobs
     FOR ALL
     TO authenticated
     USING (true)
     WITH CHECK (true);
   ```

3. Update `src/types/database.ts`:
   - Add `GenerationJobStatus` type: 'pending' | 'generating' | 'validating' | 'completed' | 'failed'
   - Add `GenerationJob` interface with all columns
   - Add to Database interface Tables section

4. Update `.env.local.example`:
   - Add `GEMINI_API_KEY=your-gemini-api-key` with comment about Google AI Studio
  </action>
  <verify>
    - `npm ls @google/genai` shows package installed
    - `npx tsc --noEmit` - TypeScript compiles
  </verify>
  <done>
    - Dependencies installed
    - Migration file ready to apply
    - GenerationJob type available
    - GEMINI_API_KEY documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod schemas for structured output</name>
  <files>
    src/lib/gemini/schemas.ts
  </files>
  <action>
Create `src/lib/gemini/schemas.ts`:

```typescript
import { z } from 'zod';
import { zodToJsonSchema } from 'zod-to-json-schema';

/**
 * Source citation schema
 */
export const SourceSchema = z.object({
  name: z.string().describe('Name of the source publication or organization'),
  url: z.string().url().describe('URL to the source'),
});

/**
 * Full report schema matching database structure
 * Used for Gemini structured output validation
 */
export const ReportSchema = z.object({
  title: z.string()
    .min(10)
    .max(100)
    .describe('Compelling headline for the report, 10-100 characters'),

  subtitle: z.string()
    .min(20)
    .max(200)
    .describe('Supporting subheadline providing context, 20-200 characters'),

  summary: z.string()
    .min(100)
    .max(500)
    .describe('Executive summary in 2-3 sentences, 100-500 characters'),

  content: z.string()
    .min(15000) // ~3000 words minimum
    .describe('Full markdown report content. Must be 3000+ words with headers, tables, data points, and analysis.'),

  sources: z.array(SourceSchema)
    .min(5)
    .describe('At least 5 credible sources with URLs'),

  seo_title: z.string()
    .max(60)
    .describe('SEO-optimized title, max 60 characters'),

  seo_description: z.string()
    .max(160)
    .describe('SEO meta description, max 160 characters'),

  seo_keywords: z.array(z.string())
    .min(5)
    .max(10)
    .describe('5-10 relevant SEO keywords'),
});

export type ReportOutput = z.infer<typeof ReportSchema>;

/**
 * JSON Schema for Gemini structured output
 */
export const reportJsonSchema = zodToJsonSchema(ReportSchema, 'ReportSchema');
```

The schema enforces:
- Title length constraints
- Minimum content length (~3000 words = ~15000 chars)
- At least 5 sources
- SEO fields with proper limits
  </action>
  <verify>
    `npx tsc --noEmit` - TypeScript compiles
  </verify>
  <done>
    - ReportSchema validates all required fields
    - reportJsonSchema ready for Gemini config
    - Type exports available for use
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Gemini client and prompts</name>
  <files>
    src/lib/gemini/client.ts
    src/lib/gemini/prompts.ts
  </files>
  <action>
1. Create `src/lib/gemini/prompts.ts`:

```typescript
/**
 * Build the report generation prompt
 */
export function buildReportPrompt(topic: string, category: string): string {
  return `You are an investigative journalist writing for The Daily Deep, a premium publication known for rigorous, data-driven analysis.

Write a comprehensive investigative report on: "${topic}"

Category: ${category}

REQUIREMENTS:
1. LENGTH: 3,500+ words of substantive content
2. STRUCTURE: Use markdown with clear section headers (##, ###)
3. DATA: Include specific numbers, percentages, dates, and statistics
4. TABLES: Include at least 2 markdown tables with relevant data
5. ANALYSIS: Provide deep analysis, not surface-level overview
6. BALANCE: Present multiple perspectives on controversial topics
7. SOURCES: Reference credible sources (news outlets, academic papers, official reports)
8. TONE: Professional, authoritative, accessible to general audience

SECTIONS TO INCLUDE:
- Executive Overview (2-3 paragraphs)
- Background & Context (historical perspective)
- Current Situation (recent developments, key players)
- Data Analysis (with tables and specific figures)
- Expert Perspectives (different viewpoints)
- Implications & Outlook (what this means going forward)
- Conclusion

Write the report now. Be thorough and specific.`;
}
```

2. Create `src/lib/gemini/client.ts`:

```typescript
import { GoogleGenAI } from '@google/genai';
import { reportJsonSchema, ReportSchema, ReportOutput } from './schemas';
import { buildReportPrompt } from './prompts';

/**
 * Create Gemini client instance
 */
export function createGeminiClient() {
  const apiKey = process.env.GEMINI_API_KEY;
  if (!apiKey) {
    throw new Error('GEMINI_API_KEY environment variable is required');
  }
  return new GoogleGenAI({ apiKey });
}

/**
 * Generate a report using Gemini with structured output
 * Returns validated report data or throws on error
 */
export async function generateReport(
  topic: string,
  category: string,
  onProgress?: (message: string) => Promise<void>
): Promise<ReportOutput> {
  const ai = createGeminiClient();

  await onProgress?.('Starting AI generation...');

  const prompt = buildReportPrompt(topic, category);

  const response = await ai.models.generateContent({
    model: 'gemini-2.5-flash',
    contents: prompt,
    config: {
      responseMimeType: 'application/json',
      responseSchema: reportJsonSchema,
    },
  });

  await onProgress?.('Validating report structure...');

  // Parse and validate response
  const text = response.text;
  if (!text) {
    throw new Error('Empty response from Gemini');
  }

  const parsed = JSON.parse(text);
  const validated = ReportSchema.parse(parsed);

  // Additional quality checks
  const wordCount = validated.content.split(/\s+/).length;
  if (wordCount < 3000) {
    throw new Error(`Report too short: ${wordCount} words (minimum 3000)`);
  }

  if (validated.sources.length < 5) {
    throw new Error(`Insufficient sources: ${validated.sources.length} (minimum 5)`);
  }

  await onProgress?.('Report validated successfully');

  return validated;
}
```

IMPORTANT:
- Use `gemini-2.5-flash` model (current recommended per RESEARCH.md)
- Use structured output with responseSchema
- Validate with Zod after parsing
- Additional quality checks (word count, sources)
- onProgress callback for status updates
  </action>
  <verify>
    `npx tsc --noEmit` - TypeScript compiles
  </verify>
  <done>
    - Gemini client initializes with API key
    - generateReport function with structured output
    - Quality validation (word count, sources)
    - Progress callback support
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - no TypeScript errors
2. `npm run build` - builds successfully
3. Dependencies installed: `npm ls @google/genai zod zod-to-json-schema swr`
4. Migration file exists at supabase/migrations/002_generation_jobs.sql
5. All exports available from lib/gemini/*
</verification>

<success_criteria>
- Generation infrastructure ready for API integration
- Schemas enforce quality requirements (3000+ words, 5+ sources)
- Types available for all generation job operations
- Gemini client configured with modern SDK and model
</success_criteria>

<output>
After completion, create `.planning/phases/02-generation-engine/02-02-SUMMARY.md`
</output>
