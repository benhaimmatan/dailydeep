---
phase: 02-generation-engine
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/trends/client.ts
  - src/app/api/trends/route.ts
  - src/components/admin/topic-selector.tsx
  - src/app/admin/(dashboard)/generate/page.tsx
  - src/app/admin/(dashboard)/generate/generation-page.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "System can query Google Trends for trending topics"
    - "Trending topics are filtered by daily category"
    - "Admin sees suggested topics with trend data"
    - "Admin can select a suggested topic or enter custom"
    - "Selected topic is passed to generation trigger"
  artifacts:
    - path: "src/lib/trends/client.ts"
      provides: "Google Trends API wrapper"
      exports: ["getDailyTrends", "getTrendsByCategory"]
    - path: "src/app/api/trends/route.ts"
      provides: "GET endpoint for trending topics"
      exports: ["GET"]
    - path: "src/components/admin/topic-selector.tsx"
      provides: "Topic selection UI with suggestions"
      exports: ["TopicSelector"]
  key_links:
    - from: "src/lib/trends/client.ts"
      to: "google-trends-api"
      via: "dailyTrends import"
      pattern: "googleTrends"
    - from: "src/components/admin/topic-selector.tsx"
      to: "/api/trends"
      via: "fetch trending topics"
      pattern: "fetch.*trends"
    - from: "src/app/admin/(dashboard)/generate/generation-page.tsx"
      to: "src/components/admin/topic-selector.tsx"
      via: "TopicSelector component"
      pattern: "TopicSelector"
---

<objective>
Integrate Google Trends API to discover trending topics and provide topic suggestions on the generation page.

Purpose: Instead of manually guessing topics, admin sees what's trending in today's category. This improves report relevance and saves time on topic research.

Output: Google Trends client, topics API endpoint, topic selector component with suggestions.
</objective>

<execution_context>
@/Users/matanbenhaim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matanbenhaim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-generation-engine/02-CONTEXT.md
@.planning/phases/02-generation-engine/02-RESEARCH.md

@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Google Trends client</name>
  <files>
    package.json
    src/lib/trends/client.ts
  </files>
  <action>
1. Install google-trends-api:
   ```bash
   npm install google-trends-api
   npm install -D @types/google-trends-api
   ```

2. Create `src/lib/trends/client.ts`:

```typescript
import googleTrends from 'google-trends-api';

/**
 * Trending topic from Google Trends
 */
export interface TrendingTopic {
  title: string;
  traffic: string; // e.g., "100K+"
  relatedQueries: string[];
}

/**
 * Map category names to Google Trends category IDs
 * These are approximate mappings - Google's categories don't perfectly align
 */
const CATEGORY_MAP: Record<string, number | undefined> = {
  'Geopolitics': 16, // News -> World
  'Economics': 7, // Business
  'Technology': 5, // Computers & Electronics
  'Climate': 174, // Science -> Environment
  'Society': 14, // People & Society
  'Science': 174, // Science
  'Conflict': 16, // News -> World (closest match)
};

/**
 * Get daily trending topics from Google Trends
 * @param geo - Country code (default: US)
 * @returns Array of trending topics
 */
export async function getDailyTrends(geo = 'US'): Promise<TrendingTopic[]> {
  try {
    const results = await googleTrends.dailyTrends({ geo });
    const data = JSON.parse(results);

    const trends = data.default.trendingSearchesDays[0]?.trendingSearches || [];

    return trends.slice(0, 20).map((trend: any) => ({
      title: trend.title?.query || '',
      traffic: trend.formattedTraffic || '',
      relatedQueries: (trend.relatedQueries || []).map((q: any) => q.query),
    }));
  } catch (error) {
    console.error('Failed to fetch daily trends:', error);
    return [];
  }
}

/**
 * Get trending topics filtered by category
 * First fetches daily trends, then filters/ranks by relevance to category
 */
export async function getTrendsByCategory(
  categoryName: string,
  geo = 'US'
): Promise<TrendingTopic[]> {
  // Get all daily trends
  const allTrends = await getDailyTrends(geo);

  // Get category-specific interest if available
  const categoryId = CATEGORY_MAP[categoryName];

  if (!categoryId) {
    // No mapping - return general trends
    return allTrends.slice(0, 10);
  }

  try {
    // Try to get category-specific trends using interestByRegion
    // This gives us topics that are more relevant to the category
    const categoryResults = await googleTrends.interestByRegion({
      keyword: categoryName.toLowerCase(),
      geo,
    });

    // Parse and combine with daily trends for best results
    // Return daily trends for now with the category context
    return allTrends.slice(0, 10);
  } catch (error) {
    // Fallback to daily trends if category query fails
    console.warn(`Category query failed for ${categoryName}, using daily trends`);
    return allTrends.slice(0, 10);
  }
}

/**
 * Check if a topic was recently used (to avoid repetition)
 * This will be called from the API route with Supabase
 */
export function filterUsedTopics(
  trends: TrendingTopic[],
  usedTopics: string[]
): TrendingTopic[] {
  const usedSet = new Set(usedTopics.map((t) => t.toLowerCase()));
  return trends.filter((trend) => !usedSet.has(trend.title.toLowerCase()));
}
```

The Google Trends API is unofficial and may have rate limits. Handle errors gracefully.
  </action>
  <verify>
    - `npm ls google-trends-api` shows package installed
    - `npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    - google-trends-api package installed
    - Client exports getDailyTrends and getTrendsByCategory
    - Category mapping defined for filtering
  </done>
</task>

<task type="auto">
  <name>Task 2: Create trends API endpoint</name>
  <files>
    src/app/api/trends/route.ts
  </files>
  <action>
Create `src/app/api/trends/route.ts`:

```typescript
import { createClient } from '@/lib/supabase/server';
import { NextResponse } from 'next/server';
import { getTrendsByCategory, filterUsedTopics } from '@/lib/trends/client';

export async function GET(request: Request) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  // Admin check - only admins should query trends
  if (!user || user.email !== process.env.ADMIN_EMAIL) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Get category from query params
  const { searchParams } = new URL(request.url);
  const categoryName = searchParams.get('category') || '';

  if (!categoryName) {
    return NextResponse.json({ error: 'Category required' }, { status: 400 });
  }

  try {
    // Get trending topics for category
    const trends = await getTrendsByCategory(categoryName, 'US');

    // Get recently used topics from topic_history (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const { data: usedTopics } = await supabase
      .from('topic_history')
      .select('topic')
      .gte('used_at', thirtyDaysAgo.toISOString());

    // Filter out recently used topics
    const usedTopicsList = (usedTopics || []).map((t) => t.topic);
    const filteredTrends = filterUsedTopics(trends, usedTopicsList);

    return NextResponse.json({
      category: categoryName,
      trends: filteredTrends,
      totalFound: trends.length,
      filtered: trends.length - filteredTrends.length,
    });
  } catch (error: any) {
    console.error('Trends API error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch trends', trends: [] },
      { status: 200 } // Return 200 with empty trends to allow fallback
    );
  }
}
```

The endpoint:
1. Verifies admin auth
2. Gets category from query params
3. Fetches trends for that category
4. Filters out recently used topics (from topic_history)
5. Returns trending topics or empty array on error
  </action>
  <verify>
    `npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    - GET /api/trends?category=Technology returns trending topics
    - Admin auth required
    - Recently used topics filtered out
    - Graceful error handling returns empty array
  </done>
</task>

<task type="auto">
  <name>Task 3: Create topic selector component and update generation page</name>
  <files>
    src/components/admin/topic-selector.tsx
    src/app/admin/(dashboard)/generate/generation-page.tsx
  </files>
  <action>
1. Create `src/components/admin/topic-selector.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { TrendingTopic } from '@/lib/trends/client';

interface Props {
  categoryName: string;
  value: string;
  onChange: (topic: string) => void;
  disabled?: boolean;
}

export function TopicSelector({ categoryName, value, onChange, disabled }: Props) {
  const [trends, setTrends] = useState<TrendingTopic[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [showSuggestions, setShowSuggestions] = useState(true);

  // Fetch trends when category changes
  useEffect(() => {
    if (!categoryName) return;

    async function fetchTrends() {
      setLoading(true);
      setError('');

      try {
        const res = await fetch(`/api/trends?category=${encodeURIComponent(categoryName)}`);
        const data = await res.json();

        if (data.trends) {
          setTrends(data.trends);
        } else {
          setTrends([]);
        }
      } catch (err) {
        setError('Failed to load trending topics');
        setTrends([]);
      } finally {
        setLoading(false);
      }
    }

    fetchTrends();
  }, [categoryName]);

  return (
    <div className="space-y-3">
      <div>
        <label className="block text-sm font-medium mb-2">Topic</label>
        <input
          type="text"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder="Enter a topic or select from suggestions below..."
          className="w-full px-4 py-2 bg-background border border-border rounded-md focus:ring-2 focus:ring-primary"
          required
          minLength={3}
          disabled={disabled}
        />
      </div>

      {/* Trending Topics Section */}
      <div className="border border-border rounded-md p-4 bg-muted/30">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-sm font-medium flex items-center gap-2">
            <span className="text-primary">Trending in {categoryName}</span>
            {loading && <span className="animate-pulse">...</span>}
          </h3>
          <button
            type="button"
            onClick={() => setShowSuggestions(!showSuggestions)}
            className="text-xs text-muted-foreground hover:text-foreground"
          >
            {showSuggestions ? 'Hide' : 'Show'}
          </button>
        </div>

        {showSuggestions && (
          <>
            {error && (
              <p className="text-xs text-amber-500 mb-2">{error}</p>
            )}

            {trends.length === 0 && !loading && (
              <p className="text-xs text-muted-foreground">
                No trending topics found. Enter a custom topic above.
              </p>
            )}

            {trends.length > 0 && (
              <div className="space-y-2">
                {trends.slice(0, 5).map((trend, index) => (
                  <button
                    key={index}
                    type="button"
                    onClick={() => onChange(trend.title)}
                    disabled={disabled}
                    className={`w-full text-left px-3 py-2 rounded-md text-sm transition-colors
                      ${value === trend.title
                        ? 'bg-primary/20 border border-primary text-primary'
                        : 'bg-background border border-border hover:border-primary/50'
                      }
                      disabled:opacity-50 disabled:cursor-not-allowed
                    `}
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-medium">{trend.title}</span>
                      {trend.traffic && (
                        <span className="text-xs text-muted-foreground">
                          {trend.traffic} searches
                        </span>
                      )}
                    </div>
                    {trend.relatedQueries.length > 0 && (
                      <p className="text-xs text-muted-foreground mt-1">
                        Related: {trend.relatedQueries.slice(0, 3).join(', ')}
                      </p>
                    )}
                  </button>
                ))}

                {trends.length > 5 && (
                  <p className="text-xs text-muted-foreground text-center mt-2">
                    +{trends.length - 5} more trending topics
                  </p>
                )}
              </div>
            )}
          </>
        )}
      </div>

      <p className="text-xs text-muted-foreground">
        Select a trending topic or enter your own. Recently used topics are filtered out.
      </p>
    </div>
  );
}
```

2. Update `src/app/admin/(dashboard)/generate/generation-page.tsx` to use TopicSelector:

Read the file first, then update to replace the simple topic input with TopicSelector:
- Import TopicSelector
- Replace the topic input in GenerationTrigger with TopicSelector
- Pass the selected category name to TopicSelector

The GenerationTrigger component needs to be updated to accept a categoryName prop and use TopicSelector. Update the integration so that:
1. Category select determines which trends are shown
2. TopicSelector fetches and displays relevant trends
3. Admin can click a suggestion or type custom topic
4. Selected topic flows to generation trigger
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles
    2. Run dev server, login, visit /admin/generate
    3. Category selection shows trending topics
    4. Clicking a trend fills the topic field
    5. Custom topic entry still works
  </verify>
  <done>
    - TopicSelector shows trending topics for selected category
    - Admin can click to select or type custom topic
    - Trends auto-refresh when category changes
    - Generation page integrates TopicSelector
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - no TypeScript errors
2. `npm run build` - builds successfully
3. `npm ls google-trends-api` - package installed
4. Visit /admin/generate - topic selector shows trends
5. Change category - trends refresh
6. Click a trend - topic field updates
7. Type custom topic - works normally
</verification>

<success_criteria>
- Google Trends integration discovers relevant topics
- Topics filtered by category and topic history
- Admin sees 5+ topic suggestions with trend data
- Admin can select suggestion or enter custom topic
- Graceful degradation if Trends API unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/02-generation-engine/02-05-SUMMARY.md`
</output>
