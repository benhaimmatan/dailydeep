---
phase: 03-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/003_cron_runs.sql
  - vercel.json
  - src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Cron runs can be logged to database for admin visibility"
    - "Vercel cron is configured for 6AM UTC weekdays"
    - "Database schema supports tracking cron execution history"
  artifacts:
    - path: "supabase/migrations/003_cron_runs.sql"
      provides: "Cron run history table with RLS"
      contains: "CREATE TABLE cron_runs"
    - path: "vercel.json"
      provides: "Cron job schedule configuration"
      contains: "0 6 * * 1-5"
    - path: "src/types/database.ts"
      provides: "CronRun TypeScript interface"
      contains: "interface CronRun"
  key_links:
    - from: "vercel.json"
      to: "/api/cron/generate"
      via: "cron path configuration"
      pattern: "path.*api/cron/generate"
---

<objective>
Set up cron infrastructure: database table for run history, Vercel cron schedule configuration, and TypeScript types.

Purpose: Create the foundation for automated daily generation - the database schema and scheduling config that the cron endpoint will use.
Output: Migration file for cron_runs table, vercel.json with weekday 6AM schedule, CronRun type definition.
</objective>

<execution_context>
@/Users/matanbenhaim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matanbenhaim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-automation/03-CONTEXT.md
@.planning/phases/03-automation/03-RESEARCH.md

# Existing infrastructure
@supabase/migrations/002_generation_jobs.sql
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cron_runs database migration</name>
  <files>supabase/migrations/003_cron_runs.sql</files>
  <action>
Create SQL migration file for cron_runs table to track execution history:

```sql
-- Cron run history for dashboard visibility and debugging
CREATE TABLE cron_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  status TEXT NOT NULL CHECK (status IN ('success', 'skipped', 'failed')),
  topic TEXT,
  category_name TEXT,
  report_id UUID REFERENCES reports(id) ON DELETE SET NULL,
  error TEXT,
  skip_reason TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for recent runs query (dashboard displays last 30 days)
CREATE INDEX idx_cron_runs_started ON cron_runs(started_at DESC);

-- RLS policies
ALTER TABLE cron_runs ENABLE ROW LEVEL SECURITY;

-- Authenticated users (admin) can read cron runs
CREATE POLICY "Authenticated users can read cron runs"
  ON cron_runs FOR SELECT TO authenticated USING (true);

-- Allow inserts for cron endpoint (will validate CRON_SECRET at API level)
CREATE POLICY "Allow insert for cron runs"
  ON cron_runs FOR INSERT WITH CHECK (true);
```

Note: The permissive INSERT policy is acceptable because the cron endpoint itself validates CRON_SECRET. This is internal logging data only.
  </action>
  <verify>
File exists at supabase/migrations/003_cron_runs.sql.
Contains CREATE TABLE: `grep "CREATE TABLE cron_runs" supabase/migrations/003_cron_runs.sql`
Contains status check constraint: `grep "CHECK.*status" supabase/migrations/003_cron_runs.sql`
  </verify>
  <done>
Migration file ready for Supabase. Has proper indexes, RLS policies, and foreign key to reports table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CronRun type to database types</name>
  <files>src/types/database.ts</files>
  <action>
Add CronRun interface to src/types/database.ts after the GenerationJob interface:

```typescript
/**
 * Cron run execution record for tracking automated generation
 */
export interface CronRun {
  id: string
  started_at: string
  completed_at: string | null
  status: 'success' | 'skipped' | 'failed'
  topic: string | null
  category_name: string | null
  report_id: string | null
  error: string | null
  skip_reason: string | null
  created_at: string
}
```

Place this after the GenerationJob interface definition to keep related types together.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Type exported: `grep "export interface CronRun" src/types/database.ts`
  </verify>
  <done>
CronRun TypeScript interface available for import across the codebase.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create vercel.json with cron schedule</name>
  <files>vercel.json</files>
  <action>
Create vercel.json at project root:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "crons": [
    {
      "path": "/api/cron/generate",
      "schedule": "0 6 * * 1-5"
    }
  ]
}
```

Schedule explanation:
- `0` = minute 0 (top of the hour)
- `6` = hour 6 UTC (6AM UTC)
- `*` = any day of month
- `*` = any month
- `1-5` = Monday (1) through Friday (5)

Result: Vercel will invoke GET /api/cron/generate at 6:00 AM UTC every weekday with Authorization header.

Note: The endpoint /api/cron/generate will be created in Plan 03-02.
  </action>
  <verify>
File exists: `ls vercel.json`
Valid JSON: `node -e "require('./vercel.json')"` succeeds with no errors
Contains cron config: `grep -E "(crons|schedule)" vercel.json`
  </verify>
  <done>
Vercel cron configured for 6AM UTC weekdays. Will invoke /api/cron/generate endpoint starting next deployment.
  </done>
</task>

</tasks>

<verification>
1. All files created: `ls supabase/migrations/003_cron_runs.sql vercel.json`
2. TypeScript compiles: `npx tsc --noEmit`
3. Migration has correct structure: `grep -E "(CREATE TABLE|CHECK|POLICY|INDEX)" supabase/migrations/003_cron_runs.sql`
4. vercel.json is valid JSON: `node -e "require('./vercel.json')"`
</verification>

<success_criteria>
- 003_cron_runs.sql migration file ready for Supabase with proper indexes and RLS
- CronRun TypeScript interface defined in database types
- vercel.json configured with 6AM UTC weekday schedule pointing to /api/cron/generate
- TypeScript compiles without errors
- No new npm dependencies required
</success_criteria>

<output>
After completion, create `.planning/phases/03-automation/03-01-SUMMARY.md`
</output>
