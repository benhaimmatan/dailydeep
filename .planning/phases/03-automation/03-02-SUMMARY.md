---
phase: 03-automation
plan: 02
subsystem: api, infra
tags: [cron, vercel, idempotency, generation, async, fire-and-forget]

# Dependency graph
requires:
  - phase: 02-generation-engine
    provides: generateReport function and generation_jobs table
  - phase: 03-automation/01
    provides: vercel.json cron config and cron_runs migration
provides:
  - Cron endpoint with CRON_SECRET authentication
  - UTC-based idempotency checks (hasReportForToday)
  - Stuck job cleanup (cleanupStuckJobs)
  - Shared generation runner for admin and cron endpoints
  - Retry button for failed generation jobs
affects: [03-automation/03, monitoring, operations]

# Tech tracking
tech-stack:
  added: []
  patterns: [fire-and-forget async, idempotency via date query, shared runner module]

key-files:
  created:
    - src/lib/cron/utils.ts
    - src/lib/generation/runner.ts
    - src/app/api/cron/generate/route.ts
  modified:
    - src/app/api/admin/generate/route.ts
    - src/components/admin/generation-status.tsx
    - src/types/database.ts

key-decisions:
  - "30-minute timeout for stuck job cleanup"
  - "UTC dates for all idempotency checks"
  - "Fire-and-forget pattern preserved in shared runner"
  - "CronRun type added to database types"

patterns-established:
  - "Cron auth: Bearer token via Authorization header"
  - "Idempotency: date-range query on published_at"
  - "Shared generation logic in lib/generation/runner.ts"

# Metrics
duration: 5min
completed: 2026-01-26
---

# Phase 03 Plan 02: Cron Endpoint Implementation Summary

**Secured cron endpoint with UTC-based idempotency, stuck job cleanup, shared generation runner, and retry functionality for failed jobs**

## Performance

- **Duration:** 5 min
- **Started:** 2026-01-26T15:12:21Z
- **Completed:** 2026-01-26T15:17:30Z
- **Tasks:** 4
- **Files modified:** 6

## Accomplishments

- Cron endpoint validates CRON_SECRET and returns 401 for unauthorized requests
- Idempotency: returns 200 OK with skip message if report already exists for today (UTC)
- Stuck jobs (>30 minutes) automatically marked as failed before processing
- Shared runGeneration module used by both admin and cron endpoints
- Retry button in generation status component for failed jobs

## Task Commits

Each task was committed atomically:

1. **Task 1: Create cron utility functions** - `c877a26` (feat)
2. **Task 2: Extract runGeneration to shared module** - `ddb0b67` (refactor)
3. **Task 3: Create cron endpoint with idempotency and security** - `421b3e0` (feat)
4. **Task 4: Add retry button to generation status component** - `b45337d` (feat)

## Files Created/Modified

- `src/lib/cron/utils.ts` - Idempotency and logging functions (hasReportForToday, hasInProgressJob, cleanupStuckJobs, logCronRun)
- `src/lib/generation/runner.ts` - Shared generation workflow for fire-and-forget pattern
- `src/app/api/cron/generate/route.ts` - Secured cron endpoint with full idempotency checks
- `src/app/api/admin/generate/route.ts` - Refactored to use shared runner module
- `src/components/admin/generation-status.tsx` - Added retry button and onRetry callback
- `src/types/database.ts` - Added CronRun and CronRunStatus types

## Decisions Made

- **30-minute stuck job threshold:** Generation typically takes 5-15 minutes, so 30 minutes is a safe timeout
- **UTC dates for idempotency:** Ensures consistent behavior regardless of server timezone
- **CronRun type in database.ts:** Needed for type-safe logCronRun function parameters

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added CronRun type to database types**
- **Found during:** Task 1 (cron utility functions)
- **Issue:** Plan referenced CronRun type from @/types/database but it didn't exist
- **Fix:** Added CronRun interface and CronRunStatus type to database.ts
- **Files modified:** src/types/database.ts
- **Verification:** TypeScript compiles without errors
- **Committed in:** c877a26 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Type definition was necessary for TypeScript compilation. No scope creep.

## Issues Encountered

None - plan executed as specified with the type addition noted above.

## User Setup Required

None - cron endpoint uses CRON_SECRET which is auto-generated by Vercel. The cron_runs table migration was added in plan 03-01.

## Next Phase Readiness

- Cron endpoint complete and ready for Vercel deployment
- Plan 03 (vercel.json schedule configuration) can be executed
- Plan 04 (monitoring dashboard) has all data sources ready via cron_runs table
- CRON_SECRET environment variable needs to be set in Vercel for production

---
*Phase: 03-automation*
*Completed: 2026-01-26*
