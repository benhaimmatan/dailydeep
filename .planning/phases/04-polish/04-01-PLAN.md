---
phase: 04-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/report/[slug]/page.tsx
  - src/app/report/[slug]/opengraph-image.tsx
autonomous: true

must_haves:
  truths:
    - "Each report page has unique meta title, description, and keywords"
    - "Reports have OpenGraph meta tags for social sharing"
    - "Reports have Twitter Card meta tags for social sharing"
    - "Social sharing previews display dynamic images with report title and branding"
  artifacts:
    - path: "src/app/report/[slug]/opengraph-image.tsx"
      provides: "Dynamic OG image generation"
      exports: ["default", "alt", "size", "contentType"]
    - path: "src/app/layout.tsx"
      provides: "metadataBase for absolute URL resolution"
      contains: "metadataBase"
    - path: "src/app/report/[slug]/page.tsx"
      provides: "Extended metadata with Twitter Cards"
      contains: "twitter:"
  key_links:
    - from: "src/app/report/[slug]/page.tsx"
      to: "generateMetadata"
      via: "Next.js Metadata API"
      pattern: "twitter:\\s*\\{"
    - from: "src/app/report/[slug]/opengraph-image.tsx"
      to: "Database"
      via: "getReport function"
      pattern: "getReport"
---

<objective>
Add dynamic meta tags, Twitter Cards, and OG image generation for report pages.

Purpose: Enable beautiful social sharing previews and proper meta tag SEO for all report pages.
Output: Report pages have full OpenGraph/Twitter Card support with dynamically generated branded images.
</objective>

<execution_context>
@/Users/matanbenhaim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matanbenhaim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish/04-CONTEXT.md
@.planning/phases/04-polish/04-RESEARCH.md
@src/app/report/[slug]/page.tsx
@src/app/layout.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add metadataBase to root layout</name>
  <files>src/app/layout.tsx</files>
  <action>
    Update the root layout to include metadataBase for proper absolute URL resolution.

    Add to the existing metadata export:
    ```typescript
    export const metadata: Metadata = {
      metadataBase: new URL(process.env.NEXT_PUBLIC_SITE_URL || 'https://thedailydeep.com'),
      title: {
        default: "The Daily Deep",
        template: "%s | The Daily Deep",
      },
      description: "Premium AI-powered investigative reports published daily",
    }
    ```

    The template ensures all page titles get the branded suffix. metadataBase ensures OG images resolve to absolute URLs.

    Note: Keep existing font imports and ThemeProvider structure unchanged.
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>Root layout has metadataBase and title template configured</done>
</task>

<task type="auto">
  <name>Task 2: Extend generateMetadata with Twitter Cards</name>
  <files>src/app/report/[slug]/page.tsx</files>
  <action>
    Enhance the existing generateMetadata function to include full Twitter Card support.

    Update the metadata return to include:
    - title using seo_title with fallback to title
    - description using seo_description with fallback to summary
    - keywords from seo_keywords array
    - openGraph with type: 'article', publishedTime, modifiedTime, authors, section
    - twitter with card: 'summary_large_image', title, description

    The openGraph images array can be omitted since the file-based opengraph-image.tsx will be auto-discovered by Next.js.

    Add article metadata:
    ```typescript
    openGraph: {
      type: 'article',
      title: report.seo_title || report.title,
      description: report.seo_description || report.summary || report.content.slice(0, 160).trim() + '...',
      publishedTime: report.published_at || undefined,
      modifiedTime: report.updated_at,
      authors: ['The Daily Deep'],
      section: report.category?.name || 'News',
    },
    twitter: {
      card: 'summary_large_image',
      title: report.seo_title || report.title,
      description: report.seo_description || report.summary || report.content.slice(0, 160).trim() + '...',
    },
    ```
  </action>
  <verify>Run `npm run build` - should compile without errors. Check output for metadata types.</verify>
  <done>Report pages generate Twitter Card and enhanced OpenGraph metadata</done>
</task>

<task type="auto">
  <name>Task 3: Create dynamic OG image generator</name>
  <files>src/app/report/[slug]/opengraph-image.tsx</files>
  <action>
    Create a new file that generates dynamic OG images for each report.

    Use Next.js file-based metadata convention with ImageResponse from 'next/og'.

    Key implementation details:
    1. Export alt, size (1200x630), and contentType
    2. Create async default function that takes params: Promise<{ slug: string }>
    3. Fetch report data using the same getReport pattern from page.tsx
    4. Load Playfair Display font from Google Fonts API for brand consistency
    5. Return ImageResponse with JSX layout:
       - Dark background (#111111)
       - Category name in gold (#C9A962) at top
       - Report title in large Playfair Display, white text
       - "The Daily Deep" branding at bottom in gold

    Font loading pattern (from research):
    ```typescript
    async function loadGoogleFont(font: string, text: string): Promise<ArrayBuffer> {
      const url = `https://fonts.googleapis.com/css2?family=${font}&text=${encodeURIComponent(text)}`
      const css = await (await fetch(url)).text()
      const resource = css.match(/src: url\((.+)\) format\('(opentype|truetype)'\)/)
      if (resource) {
        const response = await fetch(resource[1])
        if (response.status === 200) {
          return await response.arrayBuffer()
        }
      }
      throw new Error('Failed to load font data')
    }
    ```

    Create Supabase client inline (copy pattern from page.tsx getReport).

    Handle not-found case by showing generic "The Daily Deep" image.

    Colors from design system: background #111111, gold accent HSL(43, 74%, 59%) = #C9A962, text white #F2F2F2.
  </action>
  <verify>
    Run `npm run build` - should compile without errors.
    Run `npm run dev`, visit /report/[any-slug], check network tab for opengraph-image request.
    Use social preview debugger (https://www.opengraph.xyz/) to verify image generation.
  </verify>
  <done>Dynamic OG images generate with report title, category, and branding</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build` completes without errors
2. Social preview test: Use https://www.opengraph.xyz/ with a report URL to verify:
   - OG image shows with title, category, branding
   - Twitter Card meta tags are present
   - Description is populated from seo_description
3. Meta inspection: View page source on report page, confirm twitter: meta tags present
</verification>

<success_criteria>
- Report pages have `og:type`, `og:title`, `og:description`, `og:image` meta tags
- Report pages have `twitter:card`, `twitter:title`, `twitter:description` meta tags
- OG images are dynamically generated with report title and branded styling
- All meta tags use absolute URLs (via metadataBase)
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-01-SUMMARY.md`
</output>
